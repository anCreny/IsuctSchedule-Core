<!DOCTYPE html>
<html lang="en" style="height: 98%">
<head>
    <meta charset="UTF-8">
    <title>Shared Day</title>
    <style>
        h1, h2 {text-align: center; color: #78aeed}
        table {height: 60%; border: lightgrey; margin: auto}
        body {background: #242424; font-family: Calibri; font-size: 2.2vh}
        th {color: aquamarine; background: #363636; padding: 8px}
        td {color: white; background: #363636; padding: 15px; max-width: 33vh;}
        button {
            display: inline-block;
            border: 0;
            background: #363636;
            color: white;
            height: 10vh;
            width: 40vh;
            font-size: 4vh;
            border-radius: 15px;
        }
        button:hover{ background: #3e3e3e }
        .timeBar{
            height: 0%;
            width: 100%;
            background-color: #496ee8;
        }

        .thTimeBar{
            padding: 0;
            vertical-align: baseline;
            overflow: hidden;
        }
    </style>
</head>
    <body style="
    display: flex;
    flex-direction: column;
    height: 100%;
    ">
    <div style="
    flex: 1 0 auto;
    ">
        <div>
            <h1 id="day">Today</h1>
        </div>
        <div>
            <h2 id="week">of the week</h2>
        </div>
        <div>
            <h2 id="holder">Loading...</h2>
        </div>

        
    <table id="allday" style="justify-content: center; margin: auto">
        <tbody id="tbody">
            <tr>
                <th style="border-top-left-radius: 15px; display: none;" id="time">Time</th>
                <th style="border-top-right-radius: 15px; display: none;" id="lesson">Lessons</th>
            </tr>
        </tbody>
    </table>
        
    </div>
    <div style="text-align: center; flex: 0 0 auto">
        <button onclick="location.href ='/' ">Menu</button>
    </div>
    <script>
            let dates = [];
            const urlParams = new URLSearchParams(window.location.search);
            let offset = urlParams.get('offset');

            if (offset === null) {
                offset = "0";
            }
            const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
            
            async function GetDay(){

                let path = document.location.pathname.split("/")

                let type = path[2]
                let holder = path[3]

                let h = document.getElementById("holder")
                h.innerText = holder
                
                let requestURL;

                switch (type){
                    case "teacher":
                        requestURL = `api/teacher/${holder}`
                        break
                    case "group":
                        requestURL = `api/group/${holder}`
                }
                
                const response = await fetch(`http://188.120.234.21:9818/${requestURL}/day?offset=${offset}`, {
                    method: "GET",
                    headers: {"Accept" : "application/json"},
                });
                
                if (response.ok === true){
                    const day = await response.json();
                    SetDay(day);
                }
            }
            
            let counter = 0;
            let end;

            function SetDay(day){
                if (day.weekday === 0) {
                    document.getElementById("day").innerText = "Sunday"
                }
                else{
                    document.getElementById("day").innerText = days[day.weekday - 1];
                }
                let week;
                switch (day.week){
                    case 1:
                        week = "of the first week."
                        break;
                    case 2:
                        week = "of the second week."
                        break;
                }
                document.getElementById("week").innerText = week;
                if (day.lessons === null || day.weekday === -1 || day.lessons.length === 0){
                    document.getElementById("allday").style.display = "none";
                }else{
                    end = day.lessons.length
                    
                    let time = document.getElementById("time")
                    time.style.display = "table-cell";
                    
                    let lesson = document.getElementById("lesson")
                    lesson.style.display = "table-cell";
                    
                    day.lessons.forEach( l => SetLesson(l))
                }
            }
            let td = document.getElementById("lesson");
            
            function SetLesson(lesson){
                td.style.borderBottomRightRadius = ""
                const table = document.getElementById("tbody");
                const tr = document.createElement("tr");
                const th = document.createElement("th");
                td = document.createElement("td");
                td.style.borderBottomRightRadius = "15px"
                
                const time = (lesson.time.start + ":" + lesson.time.end).split(":");
                
                th.innerText = time[0] + ":" + time[1] + "-\n" + time[3] + ":" + time[4];
                
                let content = lesson.name + (lesson.type === "—" ? "" : ("[" + lesson.type + "]" )) + "\n";
                lesson.audience.forEach(a => content += a.audience === "—" ? "" : a.audience + "\n");
                lesson.teachers.forEach(t => content += t.teacher === "—" ? "" : t.teacher + "\n");
                td.innerText = content;

                switch (lesson.type){
                    case "лаб.":
                        td.style.backgroundColor = "#526D73";
                        break;
                    case "пр.з.":
                        td.style.backgroundColor = "#735252";
                        break;
                    case "лк.":
                        td.style.backgroundColor = "#657352";
                        break;
                    case "—":
                        td.style.backgroundColor = "rgb(129 129 129)";
                }
                
                
                if (counter === end-1){
                    th.style.borderBottomLeftRadius = "15px";
                }
                tr.append(th);
                tr.appendChild(td);
                table.append(tr);
                
                const startPoint = new Date();
                startPoint.setHours(Number(time[0]), Number(time[1]));
                startPoint.setTime(startPoint.getTime() + (Number(offset) * 24 * 60 * 60 * 1000));
                const endPoint = new Date();
                endPoint.setHours(Number(time[3]), Number(time[4]));
                endPoint.setTime(endPoint.getTime() + (Number(offset) * 24 * 60 * 60 * 1000));
                
                
                let m = [startPoint, endPoint];
                dates.push(m);
                
                counter++;
            }
            GetDay();

        </script>
    </body>
</html>